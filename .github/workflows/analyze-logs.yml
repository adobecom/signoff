name: Analyze Test Logs

on:
  workflow_dispatch:
    inputs:
      run_url:
        description: 'GitHub Actions or CircleCI run URL to analyze'
        required: true
        type: string
      jira_issue_key:
        description: 'Empty string for creating a new issue. Test ticket: MWPW-185796'
        required: false
        default: ''
        type: string
      slack_channel_jira:
        description: 'Slack channel to send the notification about the Jira issue'
        required: false
        default: "#loot-loaders-tests"
        type: string
      slack_channel_alert:
        description: 'Slack channel to send the analyze logs notification'
        required: false
        default: "#loot-loaders-tests"
        type: string

jobs:
  trigger-circleci:
    runs-on: [self-hosted, Linux, X64]
    steps:
      - name: Trigger CircleCI Pipeline
        run: |
          # Prepare parameters for CircleCI
          RUN_URL="${{ inputs.run_url }}"
          JIRA_ISSUE_KEY="${{ inputs.jira_issue_key }}"
          SLACK_CHANNEL_JIRA="${{ inputs.slack_channel_jira }}"
          SLACK_CHANNEL_ALERT="${{ inputs.slack_channel_alert }}"

          PARAMETERS=$(cat <<EOF
          {
            "branch": "dev",
            "parameters": {
              "run_url": "${RUN_URL}",
              "jira_issue_key": "${JIRA_ISSUE_KEY}",
              "slack_channel_jira": "${SLACK_CHANNEL_JIRA}",
              "slack_channel_alert": "${SLACK_CHANNEL_ALERT}"
            }
          }
          EOF
          )
          
          echo "Triggering CircleCI pipeline to analyze logs from:"
          echo "${RUN_URL}"
          echo ""
          echo "Parameters:"
          echo "$PARAMETERS" | jq '.'
          
          # Trigger CircleCI pipeline
          RESPONSE=$(curl -X POST \
            --url "https://cci-ghec.ci.adobe.com/api/v2/project/gh/Adobe-acom/Alert/pipeline" \
            --header "Circle-Token: ${{ secrets.CIRCLECI_TOKEN }}" \
            --header "content-type: application/json" \
            --data "$PARAMETERS")
          
          echo ""
          echo "CircleCI Response:"
          echo "$RESPONSE" | jq '.'
          
          # Extract pipeline information
          PIPELINE_ID=$(echo "$RESPONSE" | jq -r '.id // empty')
          PIPELINE_NUMBER=$(echo "$RESPONSE" | jq -r '.number // empty')
          
          if [ -z "$PIPELINE_ID" ]; then
            echo "❌ Error: Failed to trigger CircleCI pipeline"
            echo "$RESPONSE"
            exit 1
          fi
          
          # Construct CircleCI URL
          CIRCLECI_URL="https://app.cci-ghec.ci.adobe.com/pipelines/github/Adobe-acom/alert/${PIPELINE_NUMBER}"
          
          echo ""
          echo "✅ Successfully triggered CircleCI pipeline"
          echo "Pipeline ID: ${PIPELINE_ID}"
          echo "Pipeline Number: ${PIPELINE_NUMBER}"
          echo "View CircleCI pipeline at: ${CIRCLECI_URL}"
